name: 🚀 Mo'edim Automated Deployment

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: write
  actions: read

env:
  NODE_VERSION: '20'

jobs:
  # ========================================
  # TESTING & BUILD
  # ========================================
  test-and-build:
    name: 🧪 Test & Build
    runs-on: ubuntu-latest

    steps:
      - name: 📥 Checkout code
        uses: actions/checkout@v4

      - name: 🟢 Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: 📦 Install dependencies
        run: npm install

      - name: 🔧 Build API
        run: npm run build:api

      - name: 📱 Build Mobile (Web)
        run: npm run build:web

  # ========================================
  # DEPLOY API TO RAILWAY
  # ========================================
  deploy-railway:
    name: 🚂 Deploy API to Railway
    runs-on: ubuntu-latest
    needs: test-and-build
    if: github.ref == 'refs/heads/main'

    steps:
      - name: 📥 Checkout code
        uses: actions/checkout@v4

      - name: 🚂 Install Railway CLI
        run: npm install -g @railway/cli

      - name: 🚂 Deploy to Railway
        run: |
          railway login --token ${{ secrets.RAILWAY_TOKEN }}
          railway up --detach
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}

  # ========================================
  # DEPLOY WEB TO VERCEL
  # ========================================
  deploy-vercel:
    name: ⚡ Deploy Web to Vercel
    runs-on: ubuntu-latest
    needs: test-and-build
    if: github.ref == 'refs/heads/main'

    steps:
      - name: 📥 Checkout code
        uses: actions/checkout@v4

      - name: ⚡ Install Vercel CLI
        run: npm install -g vercel

      - name: ⚡ Deploy to Vercel
        run: vercel --prod --yes --token=${{ secrets.VERCEL_TOKEN }}
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

  # ========================================
  # UPDATE MOBILE APP CONFIG
  # ========================================
  update-mobile-config:
    name: 📱 Update Mobile App Config
    runs-on: ubuntu-latest
    needs: [deploy-railway, deploy-vercel]
    if: github.ref == 'refs/heads/main'

    steps:
      - name: 📥 Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: 🟢 Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: 📱 Update API URL in mobile app
        run: |
          # Update the API URL to use production Railway endpoint
          sed -i "s|http://localhost:3000|${{ secrets.RAILWAY_API_URL }}|g" apps/mobile/src/screens/DailyTorahScreen.tsx

      - name: 📤 Commit updated mobile config
        if: github.ref == 'refs/heads/main'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git pull origin main
          git add apps/mobile/src/screens/DailyTorahScreen.tsx
          git diff --staged --quiet || git commit -m "🤖 Update mobile app to use production API

          Co-Authored-By: Claude <noreply@anthropic.com>"
          git push origin main

  # ========================================
  # POST-DEPLOYMENT TESTING
  # ========================================
  test-production:
    name: 🧪 Test Production Deployments
    runs-on: ubuntu-latest
    needs: [deploy-railway, deploy-vercel, update-mobile-config]
    if: github.ref == 'refs/heads/main'

    steps:
      - name: 📥 Checkout code
        uses: actions/checkout@v4

      - name: 🧪 Test Railway API
        run: |
          echo "Testing Railway API endpoints..."
          curl -f ${{ secrets.RAILWAY_API_URL }}/torah/daily || exit 1
          curl -f ${{ secrets.RAILWAY_API_URL }}/ || exit 1
          echo "✅ Railway API tests passed!"

      - name: 🧪 Test Vercel Web App
        run: |
          echo "Testing Vercel web deployment..."
          curl -f ${{ secrets.VERCEL_PROJECT_URL }} || exit 1
          echo "✅ Vercel web app tests passed!"

      - name: 🎉 Deployment Success Notification
        run: |
          echo "🎉 Mo'edim deployment successful!"
          echo "📍 API: ${{ secrets.RAILWAY_API_URL }}"
          echo "🌐 Web: ${{ secrets.VERCEL_PROJECT_URL }}"
          echo "📱 Mobile app updated to use production API"